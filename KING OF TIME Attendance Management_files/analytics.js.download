(function(){var Q;"use strict";var H=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Z(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ee=function(e,t){if(t=t.split(":")[0],e=+e,!e)return!1;switch(t){case"http":case"ws":return e!==80;case"https":case"wss":return e!==443;case"ftp":return e!==21;case"gopher":return e!==70;case"file":return!1}return e!==0},E={},te=Object.prototype.hasOwnProperty,se;function Y(r){try{return decodeURIComponent(r.replace(/\+/g," "))}catch(e){return null}}function X(r){try{return encodeURIComponent(r)}catch(e){return null}}function re(r){for(var e=/([^=?#&]+)=?([^&]*)/g,t={},s;s=e.exec(r);){var i=Y(s[1]),n=Y(s[2]);i===null||n===null||i in t||(t[i]=n)}return t}function ie(r,e){e=e||"";var t=[],s,i;typeof e!="string"&&(e="?");for(i in r)if(te.call(r,i)){if(s=r[i],!s&&(s===null||s===se||isNaN(s))&&(s=""),i=X(i),s=X(s),i===null||s===null)continue;t.push(i+"="+s)}return t.length?e+t.join("&"):""}E.stringify=ie,E.parse=re;var M=ee,C=E,ne=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,V=/[\n\r\t]/g,oe=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,K=/:\d+$/,ae=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i,le=/^[a-zA-Z]:/;function U(r){return(r||"").toString().replace(ne,"")}var b=[["#","hash"],["?","query"],function(e,t){return g(t.protocol)?e.replace(/\\/g,"/"):e},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d*)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],q={hash:1,query:1};function j(r){var e;typeof window<"u"?e=window:typeof H<"u"?e=H:typeof self<"u"?e=self:e={};var t=e.location||{};r=r||t;var s={},i=typeof r,n;if(r.protocol==="blob:")s=new p(unescape(r.pathname),{});else if(i==="string"){s=new p(r,{});for(n in q)delete s[n]}else if(i==="object"){for(n in r)n in q||(s[n]=r[n]);s.slashes===void 0&&(s.slashes=oe.test(r.href))}return s}function g(r){return r==="file:"||r==="ftp:"||r==="http:"||r==="https:"||r==="ws:"||r==="wss:"}function $(r,e){r=U(r),r=r.replace(V,""),e=e||{};var t=ae.exec(r),s=t[1]?t[1].toLowerCase():"",i=!!t[2],n=!!t[3],l=0,o;return i?n?(o=t[2]+t[3]+t[4],l=t[2].length+t[3].length):(o=t[2]+t[4],l=t[2].length):n?(o=t[3]+t[4],l=t[3].length):o=t[4],s==="file:"?l>=2&&(o=o.slice(2)):g(s)?o=t[4]:s?i&&(o=o.slice(2)):l>=2&&g(e.protocol)&&(o=t[4]),{protocol:s,slashes:i||g(s),slashesCount:l,rest:o}}function ce(r,e){if(r==="")return e;for(var t=(e||"/").split("/").slice(0,-1).concat(r.split("/")),s=t.length,i=t[s-1],n=!1,l=0;s--;)t[s]==="."?t.splice(s,1):t[s]===".."?(t.splice(s,1),l++):l&&(s===0&&(n=!0),t.splice(s,1),l--);return n&&t.unshift(""),(i==="."||i==="..")&&t.push(""),t.join("/")}function p(r,e,t){if(r=U(r),r=r.replace(V,""),!(this instanceof p))return new p(r,e,t);var s,i,n,l,o,c,S=b.slice(),T=typeof e,a=this,v=0;for(T!=="object"&&T!=="string"&&(t=e,e=null),t&&typeof t!="function"&&(t=C.parse),e=j(e),i=$(r||"",e),s=!i.protocol&&!i.slashes,a.slashes=i.slashes||s&&e.slashes,a.protocol=i.protocol||e.protocol||"",r=i.rest,(i.protocol==="file:"&&(i.slashesCount!==2||le.test(r))||!i.slashes&&(i.protocol||i.slashesCount<2||!g(a.protocol)))&&(S[3]=[/(.*)/,"pathname"]);v<S.length;v++){if(l=S[v],typeof l=="function"){r=l(r,a);continue}n=l[0],c=l[1],n!==n?a[c]=r:typeof n=="string"?(o=n==="@"?r.lastIndexOf(n):r.indexOf(n),~o&&(typeof l[2]=="number"?(a[c]=r.slice(0,o),r=r.slice(o+l[2])):(a[c]=r.slice(o),r=r.slice(0,o)))):(o=n.exec(r))&&(a[c]=o[1],r=r.slice(0,o.index)),a[c]=a[c]||s&&l[3]&&e[c]||"",l[4]&&(a[c]=a[c].toLowerCase())}t&&(a.query=t(a.query)),s&&e.slashes&&a.pathname.charAt(0)!=="/"&&(a.pathname!==""||e.pathname!=="")&&(a.pathname=ce(a.pathname,e.pathname)),a.pathname.charAt(0)!=="/"&&g(a.protocol)&&(a.pathname="/"+a.pathname),M(a.port,a.protocol)||(a.host=a.hostname,a.port=""),a.username=a.password="",a.auth&&(o=a.auth.indexOf(":"),~o?(a.username=a.auth.slice(0,o),a.username=encodeURIComponent(decodeURIComponent(a.username)),a.password=a.auth.slice(o+1),a.password=encodeURIComponent(decodeURIComponent(a.password))):a.username=encodeURIComponent(decodeURIComponent(a.auth)),a.auth=a.password?a.username+":"+a.password:a.username),a.origin=a.protocol!=="file:"&&g(a.protocol)&&a.host?a.protocol+"//"+a.host:"null",a.href=a.toString()}function ue(r,e,t){var s=this;switch(r){case"query":typeof e=="string"&&e.length&&(e=(t||C.parse)(e)),s[r]=e;break;case"port":s[r]=e,M(e,s.protocol)?e&&(s.host=s.hostname+":"+e):(s.host=s.hostname,s[r]="");break;case"hostname":s[r]=e,s.port&&(e+=":"+s.port),s.host=e;break;case"host":s[r]=e,K.test(e)?(e=e.split(":"),s.port=e.pop(),s.hostname=e.join(":")):(s.hostname=e,s.port="");break;case"protocol":s.protocol=e.toLowerCase(),s.slashes=!t;break;case"pathname":case"hash":if(e){var i=r==="pathname"?"/":"#";s[r]=e.charAt(0)!==i?i+e:e}else s[r]=e;break;case"username":case"password":s[r]=encodeURIComponent(e);break;case"auth":var n=e.indexOf(":");~n?(s.username=e.slice(0,n),s.username=encodeURIComponent(decodeURIComponent(s.username)),s.password=e.slice(n+1),s.password=encodeURIComponent(decodeURIComponent(s.password))):s.username=encodeURIComponent(decodeURIComponent(e))}for(var l=0;l<b.length;l++){var o=b[l];o[4]&&(s[o[1]]=s[o[1]].toLowerCase())}return s.auth=s.password?s.username+":"+s.password:s.username,s.origin=s.protocol!=="file:"&&g(s.protocol)&&s.host?s.protocol+"//"+s.host:"null",s.href=s.toString(),s}function he(r){(!r||typeof r!="function")&&(r=C.stringify);var e,t=this,s=t.host,i=t.protocol;i&&i.charAt(i.length-1)!==":"&&(i+=":");var n=i+(t.protocol&&t.slashes||g(t.protocol)?"//":"");return t.username?(n+=t.username,t.password&&(n+=":"+t.password),n+="@"):t.password?(n+=":"+t.password,n+="@"):t.protocol!=="file:"&&g(t.protocol)&&!s&&t.pathname!=="/"&&(n+="@"),(s[s.length-1]===":"||K.test(t.hostname)&&!t.port)&&(s+=":"),n+=s+t.pathname,e=typeof t.query=="object"?r(t.query):t.query,e&&(n+=e.charAt(0)!=="?"?"?"+e:e),t.hash&&(n+=t.hash),n}p.prototype={set:ue,toString:he},p.extractProtocol=$,p.location=j,p.trimLeft=U,p.qs=C;var de=p;const O=Z(de),R=()=>document.title,ge=()=>document.referrer,pe=()=>navigator.userAgent,me=()=>Array.isArray(navigator.language)?navigator.language[0]:navigator.language,fe=()=>window.devicePixelRatio,W=()=>window.innerHeight,F=()=>window.innerWidth,Se=()=>window.outerHeight,ve=()=>window.outerWidth,_=()=>location.href,Ie=()=>location.hostname,Te=()=>location.port,N=()=>location.pathname,D=()=>location.search,x=()=>location.hash,ke=()=>({url:_(),title:R(),hostname:Ie(),port:Te(),pagePath:N(),pageSearch:D(),pageHash:x()}),we=()=>({referrer:ge(),devicePixelRatio:fe(),innerHeight:W(),innerWidth:F(),outerHeight:Se(),outerWidth:ve(),userAgent:pe(),language:me()}),G=()=>({...ke(),...we()});function ye(r,e){let t;return function(...s){t||(t=!0,r.apply(this,s),setTimeout(()=>t=!1,e))}}function h(){return window.scrollX||window.pageXOffset}function d(){return window.scrollY||window.pageYOffset}function B(){return document.documentElement.scrollHeight}function J(){return document.documentElement.scrollWidth}function Ce(){return d()<1}function Le(){return B()-d()-W()<1}function Ae(){return h()<1}function Ee(){return J()-h()-F()<1}function Ue(r){return Math.random()<=r}function m(r,...e){try{localStorage.KARAKURI_DEBUG&&console.log(`[KARAKURI ANALYTICS] ${r}
`,...e)}catch(t){}}const be=async(r,e)=>await new Promise(t=>{const s=new XMLHttpRequest;s.open("GET",e+`/config?trackingId=${r}`),s.onload=()=>{t(JSON.parse(s.responseText))},s.send(null)}),Oe=async(r,e,t)=>{const s=JSON.stringify(r),i=encodeURIComponent(s),n=btoa(i);navigator.sendBeacon&&e&&navigator.sendBeacon(t+"/collect",n)||await new Promise(l=>{const o=new XMLHttpRequest;o.open("POST",t+"/collect",!e),o.onload=l,o.send(n)})};var k={};function Re(r,e){return Object.prototype.hasOwnProperty.call(r,e)}var _e=function(r,e,t,s){e=e||"&",t=t||"=";var i={};if(typeof r!="string"||r.length===0)return i;var n=/\+/g;r=r.split(e);var l=1e3;s&&typeof s.maxKeys=="number"&&(l=s.maxKeys);var o=r.length;l>0&&o>l&&(o=l);for(var c=0;c<o;++c){var S=r[c].replace(n,"%20"),T=S.indexOf(t),a,v,I,A;T>=0?(a=S.substr(0,T),v=S.substr(T+1)):(a=S,v=""),I=decodeURIComponent(a),A=decodeURIComponent(v),Re(i,I)?Array.isArray(i[I])?i[I].push(A):i[I]=[i[I],A]:i[I]=A}return i},w=function(r){switch(typeof r){case"string":return r;case"boolean":return r?"true":"false";case"number":return isFinite(r)?r:"";default:return""}},Ne=function(r,e,t,s){return e=e||"&",t=t||"=",r===null&&(r=void 0),typeof r=="object"?Object.keys(r).map(function(i){var n=encodeURIComponent(w(i))+t;return Array.isArray(r[i])?r[i].map(function(l){return n+encodeURIComponent(w(l))}).join(e):n+encodeURIComponent(w(r[i]))}).filter(Boolean).join(e):s?encodeURIComponent(w(s))+t+encodeURIComponent(w(r)):""};k.decode=k.parse=_e,k.encode=k.stringify=Ne;let L;const De=new Uint8Array(16);function xe(){if(!L&&(L=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!L))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return L(De)}const u=[];for(let r=0;r<256;++r)u.push((r+256).toString(16).slice(1));function Pe(r,e=0){return u[r[e+0]]+u[r[e+1]]+u[r[e+2]]+u[r[e+3]]+"-"+u[r[e+4]]+u[r[e+5]]+"-"+u[r[e+6]]+u[r[e+7]]+"-"+u[r[e+8]]+u[r[e+9]]+"-"+u[r[e+10]]+u[r[e+11]]+u[r[e+12]]+u[r[e+13]]+u[r[e+14]]+u[r[e+15]]}const z={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function y(r,e,t){if(z.randomUUID&&!e&&!r)return z.randomUUID();r=r||{};const s=r.random||(r.rng||xe)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){t=t||0;for(let i=0;i<16;++i)e[t+i]=s[i];return e}return Pe(s)}class He{constructor(){this.pageviewId=y(),this.pageviewCreatedAt=new Date().toISOString()}getPageviewId(){return this.pageviewId}getPageviewCreatedAt(){return this.pageviewCreatedAt}invalidate(){this.pageviewId=y(),this.pageviewCreatedAt=new Date().toISOString()}}class Ye{constructor(e,t,s=30*60*1e3){this.storage=e,this.sessionChunk=t,this.expireMilliSeconds=s,this.invalidateHandler=[],this.initSessionId(this.sessionChunk)}initSessionId(e){const[t,s]=e?e.split("."):[],i=Number(s);t&&i&&!Number.isNaN(i)&&this.setSession(t,i),(!this.storage.getSessionId()||this.isSessionExpired())&&this.invalidate()}getSessionId(){return this.isSessionExpired()&&this.invalidate(),this.storage.getSessionId()}getSessionExpiredAt(){return this.storage.getSessionExpiredAt()}updateSessionExpired(){this.isSessionExpired()&&this.invalidate(),this.storage.setSessionExpiredAt(this.resolveExpiredAt())}addInvalidateHandler(e){this.invalidateHandler.push(e)}setSession(e,t){this.storage.setSessionId(e),this.storage.setSessionExpiredAt(t)}invalidate(){this.storage.setSessionId(y()),this.storage.setSessionExpiredAt(this.resolveExpiredAt()),this.invalidateHandler.forEach(e=>{e()})}isSessionExpired(){const e=this.storage.getSessionExpiredAt();return!e||e<Date.now()}resolveExpiredAt(){return Date.now()+this.expireMilliSeconds}}class Xe{constructor(){this.isLocalStorageAvailable=!1,this.isLocalStorageAvailable=this.canAccessLocalStorage()}getClientId(){return this.getLocalStorage().clientId}setClientId(e){const t=this.getLocalStorage();t.clientId=e,this.setLocalStorage(t)}getNumberOfVisit(){return this.getLocalStorage().numberOfVisit}setNumberOfVisit(e){const t=this.getLocalStorage();t.numberOfVisit=e,this.setLocalStorage(t)}getServiceHistories(){return this.getLocalStorage().serviceHistories}setServiceHistories(e){const t=this.getLocalStorage();t.serviceHistories=e,this.setLocalStorage(t)}getSessionId(){return this.getLocalStorage().sessionId}setSessionId(e){const t=this.getLocalStorage();t.sessionId=e,this.setLocalStorage(t)}getSessionExpiredAt(){return this.getLocalStorage().sessionExpiredAt}setSessionExpiredAt(e){const t=this.getLocalStorage();t.sessionExpiredAt=e,this.setLocalStorage(t)}getTrackingTarget(e){const s=this.getLocalStorage().isTrackingTarget;return s?s[e]:void 0}setTrackingTarget(e,t){const s=this.getLocalStorage();s.isTrackingTarget={[e]:t},this.setLocalStorage(s)}getPageviewInfo(){return this.getLocalStorage().pageviewInfo}pushPageviewInfo(e){var i;const t=this.getLocalStorage(),s=(i=t.pageviewInfo)!=null?i:[];s.push(e),s.length>9&&s.shift(),m("ðŸ˜¢ ãŠå›°ã‚Šåº¦","  timestamp                    :"+e.timestamp+`
`,"  url                          :"+e.url+`
`,"  page_title                   :"+e.page_title+`
`,"  num_click                    :"+e.num_click+`
`,"  scroll_y_cumulative          :"+e.scroll_y_cumulative+`px
`,"  staying_time_mill_second     :"+e.staying_time_mill_second+`
`,"  staying_time_mill_second (ç§’):"+((e.staying_time_mill_second||0)/1e3).toFixed(3)+`ç§’
`,"  user_agent                   :"+e.user_agent),t.pageviewInfo=s,this.setLocalStorage(t)}getIsLocalStorageAvailable(){return this.isLocalStorageAvailable}canAccessLocalStorage(){try{localStorage.getItem("krkr")}catch(e){return m("localStorage is not available.",e),!1}return!0}getLocalStorage(){return this.isLocalStorageAvailable?this.getStorage(localStorage,"krkr",{}):{}}setLocalStorage(e){this.isLocalStorageAvailable&&this.setStorage(localStorage,"krkr",e)}getStorage(e,t,s){let i=s;try{const n=e.getItem(t);n&&(i=JSON.parse(n))}catch(n){e.setItem(t,""),m("Storage parse error.",n)}return i}setStorage(e,t,s){const i=Date.now();s.createdAt||(s.createdAt=i),s.updatedAt=i,e.setItem(t,JSON.stringify(s))}}class Me{constructor(e){this.trackingId=e,this.storage=new Xe;const{clientId:t,sessionChunk:s}=this.parseTrackUrl(location.href);this.initClientId(t),this.pageClient=new He,this.sessionClient=new Ye(this.storage,s),this.sessionClient.addInvalidateHandler(()=>{this.pageClient.invalidate()}),this.countUpNumberOfVisit()}initClientId(e){e&&this.storage.setClientId(e),this.storage.getClientId()||this.storage.setClientId(y())}getClientId(){return this.storage.getClientId()}getSessionId(){return this.sessionClient.getSessionId()}getSessionExpiredAt(){return this.sessionClient.getSessionExpiredAt()}getSessionChunk(){const e=this.getSessionId(),t=this.getSessionExpiredAt();if(e&&t&&!Number.isNaN(t))return`${e}.${t}`}updateSessionExpired(){this.sessionClient.updateSessionExpired()}getPageviewId(){return this.pageClient.getPageviewId()}updatePageviewId(){this.pageClient.invalidate()}getServiceHistories(){return this.storage.getServiceHistories()}getTrackingTarget(e){return this.storage.getTrackingTarget(e)}setTrackingTarget(e,t){this.storage.setTrackingTarget(e,t)}getIsLocalStorageAvailable(){return this.storage.getIsLocalStorageAvailable()}countUpNumberOfVisit(){const e=this.storage.getNumberOfVisit();this.storage.setNumberOfVisit(e?e+1:1)}parseTrackUrl(e){const{query:t}=new O(e,!0),s=t.krkr,i=t["krkr-s"],n=t["krkr-a"];return{clientId:this.parseClientId(s),sessionChunk:this.parseSessionChunk(i),serviceHistories:this.parseServiceHistories(n)}}generateTrackUrl(e){const t=new O(e,{query:!1}),s=this.generateQuery(t.query);return t.origin+t.pathname+s+t.hash}generateQuery(e){const t=this.generateKrkrQuery();return e?e+"&"+t:"?"+t}generateKrkrQuery(){const e=this.getClientId(),t=this.getSessionChunk(),s=this.getServiceHistories();return k.stringify({...e?{krkr:this.stringifyClientId(e)}:{},...t?{"krkr-s":t}:{},...s&&s.length>0&&this.enabledAttachHistory()?{"krkr-a":this.stringifyServiceHistories(s)}:{}})}enabledAttachHistory(){return this.trackingId==="krkr-61a345ff623227001fefa251"||this.trackingId==="krkr-5fd1951bfe7b7c00123f0b8e"||this.trackingId==="krkr-test"}stringifyClientId(e){return e}parseClientId(e){let t;try{e&&(t=decodeURIComponent(e))}catch(s){}return t}parseSessionChunk(e){let t;try{e&&(t=decodeURIComponent(e))}catch(s){}return t}stringifyServiceHistories(e){return e.slice(0,10).map(t=>`${t.service}-${t.action}`).join(".")}parseServiceHistories(e){let t;try{e&&(t=decodeURIComponent(e).split(".").filter(s=>!!s).map(s=>{const[i,n]=s.split("-");return{service:i,action:n}}))}catch(s){}return t}pushPageviewInfo(e){this.storage.pushPageviewInfo({timestamp:this.pageClient.getPageviewCreatedAt(),...e})}}class Ve{constructor(e,t){this.client=e,this.events=[],this.timeoutId=-1,this.uploadAvailable=!1,this.uploadIntervalTime=3e4,this.ignoreEventNames=[],this.endpoint="",this.meta=t.meta,t.uploadAvailable&&(this.uploadAvailable=!0,this.endpoint=t.endpoint,window.addEventListener("beforeunload",this.uploadBeforeUnload.bind(this)))}startUploadInterval(e,t){this.uploadIntervalTime=e,this.ignoreEventNames=t,this.uploadInterval()}registerEvent(e,t){if(this.ignoreEventNames.includes(e)||location.protocol==="file:")return;const s=this.processEvent(e,t);location.hostname!=="localhost"&&(this.events.push(s),this.client.updateSessionExpired())}uploadEventImmediately(e,t,s=!0){this.registerEvent(e,t),this.upload(s)}setTrackingClient(e,t){this.client.setTrackingTarget(e,t)}getTrackingClient(e){return this.client.getTrackingTarget(e)}setUploadAvailable(e){this.uploadAvailable=e}applyUploadAvailable(e){const t=`TrackingTarget-${this.meta.trackingId}-${e}`;let s=this.getTrackingClient(t);s===void 0&&(s=Ue(e),this.setTrackingClient(t,s)),this.setUploadAvailable(s),m("Upload available status via TrackingRatio.","  Version    :"+this.meta.version+`
`,"  Ratio      :"+e+`
`,"  Available  :"+(s?"true":"false"))}isEmpty(){return this.events.length===0}reset(){this.events=[]}async upload(e=!1){if(!this.uploadAvailable){m("Uploading is unavailable.","  Version    :"+this.meta.version);return}if(this.isEmpty()){m("No event.","  Version    :"+this.meta.version);return}await Oe(this.events,e,this.endpoint),m("Uploaded events.","  Version    :"+this.meta.version+`
`,"  Count      :"+this.events.length),this.reset()}uploadInterval(){this.timeoutId=window.setTimeout(async()=>{await this.upload(),this.uploadInterval()},this.uploadIntervalTime)}uploadBeforeUnload(){window.clearTimeout(this.timeoutId),this.upload(!0)}processEvent(e,t){const s={version:this.meta.version,timestamp:new Date().toISOString(),trackingId:this.meta.trackingId,source:this.meta.source,faqTenantId:this.meta.faqTenantId,clientId:this.client.getClientId(),sessionId:this.client.getSessionId(),pageviewId:this.client.getPageviewId(),url:location.href,eventId:y(),eventName:e,eventParams:{...t,isLocalStorageAvailable:this.client.getIsLocalStorageAvailable()}};return m("Register event.","  Version       :"+s.version+`
`,"  Timestamp     :"+s.timestamp+`
`,"  TrackingID    :"+s.trackingId+`
`,"  Source        :"+s.source+`
`,"  FaqTenantId   :"+s.faqTenantId+`
`,"  ClientID      :"+s.clientId+`
`,"  SessionID     :"+s.sessionId+`
`,"  PageviewID    :"+s.pageviewId+`
`,"  URL           :"+s.url+`
`,"  EventID       :"+s.eventId+`
`,"  EventName     :"+s.eventName+`
`,"  EventParams   :"+JSON.stringify(s.eventParams)),s}pushPageviewInfo(e){this.client.pushPageviewInfo(e)}}function Ke(r,e){let t=1,s=r;for(;s=s.previousElementSibling;)s.nodeName.toLowerCase()===e&&++t;return t}function qe(r){const e=[];let t=r;for(;t;){const s=t.nodeName.toLowerCase(),i=t.id,n=t.className,l=Ke(t,s);let o=s;i&&(o+="#"+i),n&&typeof n=="string"&&(o+=n.split(" ").map(c=>"."+c).join("")),1<l&&(o+=":nth-of-type("+l+")"),e.unshift(o),t=t.parentElement}return e.join(" > ")}class f{setTracker(e){this.tracker=e}}class je extends f{run(){window.addEventListener("click",e=>{const{tracker:t}=this,s=e.target;if(s instanceof Element){t.setNumClick(t.getNumClick()+1);const i=qe(s);s instanceof HTMLAnchorElement?(t.eventUploader.registerEvent("click",{selector:i,clickSelector:i,clickHref:s.href,clickInnerText:s.innerText,scrollXAbsolute:h(),scrollYAbsolute:d()}),this.checkRewriteHrefElement(s)):s instanceof HTMLElement?(t.eventUploader.registerEvent("click",{selector:i,clickSelector:i,clickInnerText:s.innerText,scrollXAbsolute:h(),scrollYAbsolute:d()}),this.checkRewriteHrefElement(s)):t.eventUploader.registerEvent("click",{selector:i,clickSelector:i,scrollXAbsolute:h(),scrollYAbsolute:d()})}},{capture:!0})}checkRewriteHrefElement(e,t=0){if(!(t>=10)){if(e instanceof HTMLAnchorElement){this.rewriteHref(e);return}e.parentElement&&this.checkRewriteHrefElement(e.parentElement,t+1)}}rewriteHref(e){const t=e==null?void 0:e.href;if(!t)return;const{tracker:s}=this,i=s.getTrackingId(),n=s.getCrossDomainAllowList(),l=this.shouldAttachClientId(t,n),o=this.tracker.eventUploader.client.generateTrackUrl(t);l&&(e.href=o),m("Resolve Link.","  Version    :"+this.tracker.version+`
`,"  TrackingID :"+i+`
`,"  Raw URL    :"+t+`
`,"  Resolve URL:"+(l?o:t))}shouldAttachClientId(e,t){return this.isCrossDomain(e)?t.some(s=>this.isSameOrigin(e,s)):!1}isCrossDomain(e){return!this.isSameOrigin(e,location.href)}isSameOrigin(e,t){const s=new URL(e),i=new URL(t);return s.origin===i.origin}}class $e extends f{constructor(){super(...arguments),this.error=[],this.errorTotalCount=0,this.errorTypeCountLimit=50}saveErrorObj(e){const t=this.error.find(s=>s.message===e);t?++t.count:this.error.length<this.errorTypeCountLimit&&this.error.push({message:e,count:1})}setErrorCountLimit(e){this.errorCountLimit=e}incrementCount(){this.errorTotalCount=this.errorTotalCount+1}save(e){this.errorCountLimit&&(this.incrementCount(),this.saveErrorObj(JSON.stringify(e)))}isRegisterEvent(){return!!this.errorCountLimit&&this.errorTotalCount<=this.errorCountLimit}isPushErrorSummary(){return!!this.errorCountLimit&&this.error.length>0}run(){var t;const{tracker:e}=this;this.setErrorCountLimit((t=e.option)==null?void 0:t.ERROR_COUNT_LIMIT),window.addEventListener("error",s=>{this.save(s.message),this.isRegisterEvent()&&e.eventUploader.registerEvent("error",{message:s.message,scrollXAbsolute:h(),scrollYAbsolute:d()})}),window.addEventListener("unhandledrejection",s=>{this.save(s.reason),this.isRegisterEvent()&&e.eventUploader.registerEvent("unhandledrejection",{reason:s.reason,scrollXAbsolute:h(),scrollYAbsolute:d()})}),window.addEventListener("beforeunload",()=>{this.isPushErrorSummary()&&e.eventUploader.registerEvent("errorSummary",{message:JSON.stringify(this.error)})})}}class We extends f{run(){const{tracker:e}=this;window.addEventListener("load",()=>{e.setLoadDocumentTimestamp(Date.now()),e.eventUploader.registerEvent("load",{...G(),isLoad:!0})})}}class Fe extends f{run(){window.addEventListener("popstate",()=>{const{tracker:e}=this,t=e.getLoadDocumentTimestamp(),s=e.getLoadScriptTimestamp();if(t>0){const i=Math.floor(Date.now()-t);e.eventUploader.registerEvent("popstate",{stayingTimeMillSecond:i,stayingTimeMillSecondSource:"load-document",scrollXAbsolute:h(),scrollYAbsolute:d()})}else{const i=Math.floor(Date.now()-s);e.eventUploader.registerEvent("popstate",{stayingTimeMillSecond:i,stayingTimeMillSecondSource:"load-script",scrollXAbsolute:h(),scrollYAbsolute:d()})}})}}class Ge extends f{run(){const e=()=>{const{tracker:t}=this,s=h(),i=d(),n=t.getThresholdScrollX(),l=t.getThresholdScrollY(),o=t.getLastSendScrollX(),c=t.getLastSendScrollY();Math.abs(s-o)>n&&(t.eventUploader.registerEvent("scrollX",{scrollAbsolute:s,scrollDifference:s-o,scrollXAbsolute:s,scrollYAbsolute:i}),t.setLastSendScrollX(s)),Math.abs(i-c)>l&&(t.eventUploader.registerEvent("scrollY",{scrollAbsolute:i,scrollDifference:i-c,scrollXAbsolute:s,scrollYAbsolute:i}),t.setLastSendScrollY(i))};window.addEventListener("scroll",e)}}function P(r){return typeof r=="number"}class Be extends f{constructor(){super(),this.lastScrollTime=-1,this.lastScrollX=h(),this.lastScrollY=d()}run(){const e=ye((s,i,n)=>{if(!P(s)||!P(i)||!P(n)||i===this.lastScrollX&&n===this.lastScrollY)return;const l=this.tracker.getCumulativeScrollX()+Math.abs(i-this.lastScrollX),o=this.tracker.getCumulativeScrollY()+Math.abs(n-this.lastScrollY);this.tracker.setScrollXCumulative(l),this.tracker.setScrollYCumulative(o),this.tracker.eventUploader.registerEvent("scroll-v2",{scrollXAbsolute:i,scrollYAbsolute:n,scrollXVelocity:(i-this.lastScrollX)/(s-this.lastScrollTime),scrollYVelocity:(n-this.lastScrollY)/(s-this.lastScrollTime),scrollXCumulative:l,scrollYCumulative:o,pageHeight:B(),pageWidth:J(),isTop:Ce(),isBottom:Le(),isLeft:Ae(),isRight:Ee(),hasScrollX:i!==this.lastScrollX,hasScrollY:n!==this.lastScrollY})},this.tracker.getThresholdScrollThrottleMs()),t=()=>{const s=Date.now(),i=h(),n=d();e(s,i,n),this.update(s,i,n)};window.addEventListener("scroll",t)}update(e,t,s){this.tracker.setCumulativeScrollX(this.tracker.getCumulativeScrollX()+Math.abs(t-this.lastScrollX)),this.tracker.setCumulativeScrollY(this.tracker.getCumulativeScrollY()+Math.abs(s-this.lastScrollY)),this.lastScrollTime=e,this.lastScrollX=t,this.lastScrollY=s}}class Je{constructor(e){this.lastSendScrollX=0,this.lastSendScrollY=0,this.cumulativeScrollX=0,this.scrollXCumulative=0,this.cumulativeScrollY=0,this.scrollYCumulative=0,this.numClick=0,this.eventUploader=e}get version(){return this.eventUploader.meta.version}setOption(e){this.option=e}attachTracker(e){e.setTracker(this),e.run()}setLoadDocumentTimestamp(e){this.loadDocumentTimestamp=e}getLoadDocumentTimestamp(){return this.loadDocumentTimestamp}setLoadScriptTimestamp(e){this.loadScriptTimestamp=e}getLoadScriptTimestamp(){return this.loadScriptTimestamp}setLoadSpaDocumentTimestamp(e){this.loadSpaDocumentTimestamp=e}getLoadSpaDocumentTimestamp(){return this.loadSpaDocumentTimestamp}getThresholdScrollX(){var e,t;return(t=(e=this.option)==null?void 0:e.THRESHOLD_SCROLL_X)!=null?t:1e3}getThresholdScrollY(){var e,t;return(t=(e=this.option)==null?void 0:e.THRESHOLD_SCROLL_Y)!=null?t:1e3}getThresholdScrollThrottleMs(){return 500}getLastSendScrollX(){return this.lastSendScrollX}setLastSendScrollX(e){this.lastSendScrollX=e}getLastSendScrollY(){return this.lastSendScrollY}setLastSendScrollY(e){this.lastSendScrollY=e}getCumulativeScrollX(){return this.cumulativeScrollX}setCumulativeScrollX(e){this.cumulativeScrollX=e}getScrollXCumulative(){return this.scrollXCumulative}setScrollXCumulative(e){this.scrollXCumulative=e}getCumulativeScrollY(){return this.cumulativeScrollY}setCumulativeScrollY(e){this.cumulativeScrollY=e}getScrollYCumulative(){return this.scrollYCumulative}setScrollYCumulative(e){this.scrollYCumulative=e}setTrackingId(e){this.trackingId=e}getTrackingId(){return this.trackingId}getCrossDomainAllowList(){var e,t;return(t=(e=this.option)==null?void 0:e.CROSS_DOMAIN_ALLOW_LIST)!=null?t:[]}setNumClick(e){this.numClick=e}getNumClick(){return this.numClick}startUpload(){var e;(e=this.option)!=null&&e.EVENT_UPLOAD_INTERVAL&&this.eventUploader.startUploadInterval(this.option.EVENT_UPLOAD_INTERVAL,this.option.IGNORE_EVENT_NAMES)}applyTrackingRatio(){var e;this.eventUploader.applyUploadAvailable(((e=this.option)==null?void 0:e.TRACKING_RATIO)||1)}parseContexts(e){var s;if(!e)return;const t=(s=this.option)==null?void 0:s.CONTEXT_KEY_NAMES.reduce((i,n)=>e[n]?{...i,[n]:e[n]}:i,{});t&&Object.keys(t).length>0&&this.eventUploader.registerEvent("context",{contexts:JSON.stringify(t)})}}class ze extends f{unloadEvent(e){const{tracker:t}=this,s=t.getLoadDocumentTimestamp(),i=t.getLoadScriptTimestamp(),n=this.getStayingTime(s,i);t.eventUploader.uploadEventImmediately(e,{stayingTimeMillSecond:n,stayingTimeMillSecondSource:s>0?"load-document":"load-script",scrollXAbsolute:h(),scrollYAbsolute:d()})}pushPageviewInfo(){const{tracker:e}=this,t=e.getLoadDocumentTimestamp(),s=e.getLoadScriptTimestamp(),i=this.getStayingTime(t,s),n={url:location.href,page_title:document.title,num_click:e.getNumClick(),scroll_y_cumulative:e.getScrollYCumulative(),staying_time_mill_second:i,user_agent:navigator.userAgent};e.eventUploader.pushPageviewInfo(n)}getStayingTime(e,t){return e>0?Math.floor(Date.now()-e):Math.floor(Date.now()-t)}run(){window.addEventListener("beforeunload",()=>{this.pushPageviewInfo(),this.unloadEvent("beforeunload")}),window.addEventListener("unload",()=>this.unloadEvent("unload")),window.addEventListener("pagehide",()=>this.unloadEvent("pagehide"))}}class Qe extends f{constructor(){super(),this.lastUrl=_(),this.lastPath=N(),this.lastSearch=D(),this.lastHash=x(),this.pageTitle=R()}run(){const e=()=>{const t=_(),s=N(),i=D(),n=x();if(this.lastUrl!==t){if(!(this.lastPath===s&&this.lastSearch===i&&this.lastHash!==n)){const o=this.getStayingTime();this.pushPageviewInfo(o),this.resetTrackerValues(),this.tracker.eventUploader.client.updatePageviewId(),this.tracker.eventUploader.registerEvent("load",{...G(),stayingTimeMillSecond:o,stayingTimeMillSecondSource:"load-spa-document",scrollXAbsolute:h(),scrollYAbsolute:d(),changePath:this.lastPath!==s,changeSearch:this.lastSearch!==i,changeHash:this.lastHash!==n,isLoad:!1})}this.update(t,s,i,n)}setTimeout(e,100)};e()}pushPageviewInfo(e){this.tracker.eventUploader.pushPageviewInfo({url:this.lastUrl,page_title:this.pageTitle,num_click:this.tracker.getNumClick(),scroll_y_cumulative:this.tracker.getScrollYCumulative(),staying_time_mill_second:e,user_agent:navigator.userAgent})}resetTrackerValues(){this.tracker.setNumClick(0),this.tracker.setCumulativeScrollX(0),this.tracker.setScrollXCumulative(0),this.tracker.setCumulativeScrollY(0),this.tracker.setScrollYCumulative(0)}getStayingTime(){const e=this.tracker.getLoadSpaDocumentTimestamp();if(e>0)return Math.floor(Date.now()-e);const t=this.tracker.getLoadDocumentTimestamp();if(t>0)return Math.floor(Date.now()-t);const s=this.tracker.getLoadScriptTimestamp();return Math.floor(Date.now()-s)}update(e,t,s,i){this.lastUrl=e,this.lastPath=t,this.lastSearch=s,this.lastHash=i,this.pageTitle=R(),this.tracker.setLoadSpaDocumentTimestamp(Date.now())}}function Ze(){return"2.0.0"}const et=Date.now();function tt({trackingId:r,contexts:e,endpoint:t,source:s,faqTenantId:i}){const n=new Me(r),l=new Ve(n,{meta:{trackingId:r,version:Ze(),source:s,faqTenantId:i},endpoint:t,uploadAvailable:!0}),o=new Je(l);return o.attachTracker(new We),o.attachTracker(new ze),o.attachTracker(new Ge),o.attachTracker(new Be),o.attachTracker(new je),o.attachTracker(new Fe),o.attachTracker(new $e),o.attachTracker(new Qe),o.setTrackingId(r),o.setLoadScriptTimestamp(et),be(r,t).then(c=>{o.setOption({THRESHOLD_SCROLL_X:c.THRESHOLD_SCROLL_X,THRESHOLD_SCROLL_Y:c.THRESHOLD_SCROLL_Y,CROSS_DOMAIN_ALLOW_LIST:c.CROSS_DOMAIN_ALLOW_LIST,EVENT_UPLOAD_INTERVAL:c.EVENT_UPLOAD_INTERVAL,IGNORE_EVENT_NAMES:c.IGNORE_EVENT_NAMES,CONTEXT_KEY_NAMES:c.CONTEXT_KEY_NAMES,TRACKING_RATIO:c.TRACKING_RATIO,ERROR_COUNT_LIMIT:c.ERROR_COUNT_LIMIT}),o.applyTrackingRatio(),o.parseContexts(e),o.startUpload()}),o}try{if(window.krkr!==void 0)throw new Error("KARAKURI Tracking is already loaded.");const r=(Q=document.currentScript)!=null?Q:document.querySelector("[data-karakuri-tracking]"),e=r==null?void 0:r.dataset.karakuriTracking,t=r==null?void 0:r.dataset.karakuriSource,s=r==null?void 0:r.dataset.karakuriFaqTenantId,i=new O(r.src,!0).origin+"/v1";if(e){const n=tt({trackingId:e,contexts:r==null?void 0:r.dataset,endpoint:i,source:t,faqTenantId:s});window.krkr=(l,o)=>{l==="config"&&(n==null||n.eventUploader.registerEvent("config",o)),l==="service"&&(n==null||n.eventUploader.registerEvent("service",o)),l==="event"&&(n==null||n.eventUploader.registerEvent("event",o)),l==="faq"&&(n==null||n.eventUploader.registerEvent("faq",o))}}}catch(r){m("Unexpected error.",r)}})();
